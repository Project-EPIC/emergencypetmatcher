{% extends 'home/index.html' %}
{% load url from future %}

{% block js %}
	<script type='text/javascript'>

		$(document).ready(function(){

			/* Setup */
		    $.blockUI.defaults.applyPlatformOpacityRules = false;
		    $.ajaxSetup({traditional: true});

		    //Keep dibs on the latest candidate petreport looked at.
		    candidate_petreport_id = null;

			$('#tiles').imagesLoaded(function(){

				// Prepare layout options.
				var options = {
					autoResize: true, // This will auto-update the layout when the browser window is resized.
					container: $('#matching_container'), // Optional, used for some extra CSS styling
					offset: 2, // Optional, the distance between grid items
					itemWidth: 210 // Optional, the width of a grid item
				};

				// Get a reference to your grid items.
				var handler = $('#tiles li.item');

				// Call the layout function.
				handler.wookmark(options);
			});

			//Allow for each candidate petreport to pop up its PRDP upon click.
			$("#prdpdialog a").click(function(){

				show_prdp_dialog($(this));
				return false;
			});					

			/*Sticky - Make sure the workspace is fixed when scrolling down the page.
			$.waypoints.settings.scrollThrottle = 30;
			$('#workspace').waypoint(function(event, direction){
				$(this).parent().toggleClass('sticky', direction === "down");
				event.stopPropagation();
			}); */

			//Make the Candidate Petreports draggable.
			$("#tiles li.item").draggable({ 
				revert: "invalid",
				helper: "clone"
			});

			//Make the workspace dotted boxed divs droppable.
			$(".droppable").droppable({
				/* activeClass: "ui-state-hover", */
				hoverClass: "ui-state-active",
				drop: function (event, ui) {
					moveImage(ui.draggable, $(this));
				}
			});

			//Click Event handler for any candidate (Droppable) Petreport in the Workspace.
			$(".droppable").click(function(){

				if ($(this).has("img").length > 0){

					//Grab the Image from the candidate petreport and copy it in the Workspace Detail Div.
					var img = $(this).find("img");
					var petreport_id_element = $(this).find("#petreport_id");
					var petreport_id = $(petreport_id_element).attr("value");
					var success = get_PetReport_object(petreport_id, img);
					
				}
			});	

			//Click Event handler for the target petreport in the Workspace.
			$("#prtarget .target").click(function(){

				//Grab the Image from the target petreport and copy it in the Workspace Detail Div.
				var img = $(this);
				var petreport_id = "{{ target_petreport.id }}";
				var success = get_PetReport_object(petreport_id, img);

			});	


			$("#button_propose_match").click(function(){

				//These are the petreport IDs that will be sent to the server for rendering the confirmation dialog.
				var target_petreport = "{{ target_petreport.id }}";
				var candidate_petreport =  candidate_petreport_id;

				//Load the Dialog box.
				var dialog_box = $("<div></div>").load("/matching/propose_PetMatch/" + target_petreport + "/" + candidate_petreport + "/").dialog ({

					autoOpen: true,
					position: "top",
					closeOnEscape: true,
					show: {effect:"fade", duration:500},
					title: "Propose Match",
					modal: true,
					width: 900,
					height: "auto",
					resizable: false,
					close: function(event, ui){ 
						dialog_box.dialog('destroy').remove();
					}
				});
				
				return false;

			});


			$("#button_bookmark_pet").click(function(){


				alert("BOOKMARK PET");


			});


			$("#workspace_match_detail .matching_img").click(function(){

				var link = $(this).find('a');
				show_prdp_dialog(link);
				return false;

			});

		}); //end of document.ready()


		/******************************* Utility functions *******************************************/

		function move_petreport_to_workspace_match_detail (petreport, img){

			img_src = img.attr("src");
			var workspace_match_detail = $("#workspace_match_detail");

			//If the workspace match detail div does not yet contain an img element...
			workspace_match_detail.find(".matching_img").html("<a href = '/reporting/petreport/" + petreport.id + "/' + ><img src= " + img_src + "/></a>");

			//Change the border colors as necessary.
			$(".droppable").each(function(){ $(this).css("border-color", "black"); });
			$("#prtarget .target").css("border-color", "black");

			//We are showing a Candidate Pet Report here.
			if (img.parent().hasClass("droppable") == true){

				img.parent().css("border-color", "yellow");

				//Update the candidate petreport id.
				candidate_petreport_id = petreport.id;

				//Show both the "Propose Match" and "Bookmark Pet" Buttons.
				$("#button_propose_match").show();
				$("#button_bookmark_pet").show();				
			}

			//We are showing the Target PetReport here.
			else {

				img.css("border-color", "yellow");

				//Hide both the "Propose Match" and "Bookmark Pet" Buttons - It doesn't make any sense to show them.
				$("#button_propose_match").hide();
				$("#button_bookmark_pet").hide();
			}

			//TODO: Fill up the list.
			$(".matching_petname").html("<b>Pet Name:</b> " + petreport.pet_name);
			$(".matching_lost_found").html("<b>Lost/Found:</b> " + petreport.status);
			$(".matching_contact").html("<b>Contact:</b> <a href= '/users/" + petreport.proposed_by + "/' >" + petreport.proposed_by_username + "</a>");
			$(".matching_date").html("<b>Date Lost/Found:</b> " + petreport.date_lost_or_found);
			$(".matching_location").html("<b>Location:</b> " + petreport.location);
			$(".matching_age").html("<b>Age:</b> " + petreport.age);
			$(".matching_sex").html("<b>Sex:</b> " + petreport.sex);
			$(".matching_breed").html("<b>Breed:</b> " + petreport.breed);
			$(".matching_color").html("<b>Color:</b> " + petreport.color);
			$(".matching_size").html("<b>Size:</b> " + petreport.size);
			$(".matching_desc").html("<b>Description:</b> <div class = 'pr_desc' style='border: 1px dotted'>" + petreport.description + "</div>");

			//Turn on the Workspace detail div.
			workspace_match_detail.show(); 
		}

		function moveImage(item, container) {

			var petreport_img = $(item).find("img").clone();
			var petreport_id_element = $(item).find("#petreport_id").clone();
			var petreport_id = petreport_id_element.attr("value");

			//get the PetReport object via AJAX call.
			var success = get_PetReport_object(petreport_id, petreport_img);
			
			//Animate the drop!
			var w = container.width();
			var h = container.height();
			petreport_img.animate({height: h, width: w});
			$(container).html(petreport_img);

			//Safeguard the ID Hidden Input element tag inside of the Droppable div.
			$(container).prepend(petreport_id_element);
		}

		function get_PetReport_object (petreport_id, img){

			$.ajax({

				type:"GET",
				url:"/reporting/get_PetReport_json/" + petreport_id + "/",
				success: function(data){
					var petreport = data;
					move_petreport_to_workspace_match_detail(petreport, img);
				},
				error: function(data){
					alert("An unexpected error occurred when trying to retrieve this Pet Report's attributes. Please try again."); 
					return false;
				}
			});
		}

		function show_prdp_dialog (link){


			var dialog_box = $("<div></div>").dialog.load(link.attr('href')).dialog ({

				autoOpen: true,
				position:"top",
				closeOnEscape: true,
				show: {effect:"fade", duration:500},
				title: link.attr('title'),
				height: "auto",
				modal: true,
				width: 700,
				resizable: false,
				close: function(event, ui){ 
					dialog_box.dialog('destroy').remove();
				}

			});

			return false;
		}

	</script>
{% endblock js %}

{% block head_title %}EPM - Matching {% endblock head_title %}
{% block content_title %} The Matching Interface {% endblock content_title %}

{% block content %}

	<div id = "mi_instructions" style ="margin 0 auto; font-weight:bold;">
		<p> The matching interface allows you to click and drag potential pet reports to the workspace, which contains empty squares to put potential matches onto. To begin, survey the pet reports on the right that have been analyzed and ranked by the system to resemble a match and place them onto the workspace. When you feel that a potential match can be made, click on the "Propose Pet Match" button in the workspace. Good luck matching!</p>
	</div>

	<header id="nav">
		<ul>
			<li class="active"><a href="#">Suggested Pets</a></li>
			<!-- <li><a href="#">Manual Search</a></li> -->
		</ul>
	</header>

	<!-- Workspace for Placing Pet Report Candidate Matches-->
	<div id="workspace">

		<!-- PetReport Target and Candidates -->
		<div id="prtarget"> 
			<img class='target' src="{{ STATIC_URL }}{{ target_petreport.img_path }}">
			<div class="droppable">
				<div style="text-align:center; padding:5%; margin:20%;">Drag a Pet Report Here</div>
			</div>
		</div>

		<div id="workspace_match_detail">

			<div class = "matching_img"></div>

			<!-- PetReport info -->
			<ul>
				<li class = "matching_petname"/>
				<li class = "matching_lost_found"/>
				<li class = "matching_contact"/>
				<li class = "matching_date"/>
				<li class = "matching_location"/>
				<li class = "matching_age"/>
				<li class = "matching_sex"/>
				<li class = "matching_breed"/>
				<li class = "matching_color"/>
				<li class = "matching_size"/>
				<li class = "matching_desc"/>
			</ul><p/>

			<!-- Buttons -->
	   		<button id= "button_propose_match"> Propose Match </button>
	   		<button id= "button_bookmark_pet"> Bookmark Pet</button><br/>

		</div>
	</div>

	<!-- Container for ML-Ranked Pet Reports -->
	<div id="matching_container">
		<ul id="tiles">
			{% block pet_reports_content %}
				{% if pet_reports_list %}
					{% for pet_report in pet_reports_list %}
						<li class="item" >
							<input id="petreport_id" type="hidden" value="{{ pet_report.id }}"/>
							<div id = "prdpdialog">
								<a href= "{% url 'disp_PetReport' pet_report.id %}">
									{% if pet_report.pet_name %}
										<strong>{{ pet_report.pet_name }}</strong><br/>
									{% endif %}
									{{ pet_report.status }}: {{ pet_report.pet_type }} <br/>
									Contact : {{ pet_report.proposed_by.user.username }}
									<img src="{{ STATIC_URL }}{{ pet_report.img_path }}"/>
								</a>
							</div>
						</li>	
					{% endfor %}							
				{% else %}
				    <p>No pet reports are available.</p>
				{% endif %}
			{% endblock pet_reports_content %}

			<!-- Pagination -->
			<div class="pagination" align="left">
	   			<div class="step-links" id="footer" align="left">
	        		{% if pet_reports_list.has_previous %}
	           			<a href="?page={{ pet_reports_list.previous_page_number }}">previous</a>
	        		{% endif %}
	        	</div>	
	       		<div class="current" id="footer" align="left">
	            	Page {{ pet_reports_list.number }} of {{ pet_reports_list.paginator.num_pages }}.
	        	</div>
	        	<div class="step-links" id="footer" align="left">	
	        		{% if pet_reports_list.has_next %}
	            		<a href="?page={{ pet_reports_list.next_page_number }}">next</a>
	        		{% endif %}
	        	</div>		
	    	</div>
		</ul>	
	</div>

	{% block chat %}
	{% endblock chat %}

{% endblock content %}